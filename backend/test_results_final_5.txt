============================= test session starts =============================
platform win32 -- Python 3.13.2, pytest-7.4.3, pluggy-1.6.0 -- C:\Users\engan\AppData\Local\Programs\Python\Python313\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\engan\OneDrive\Área de Trabalho\sigma\backend
configfile: pytest.ini
plugins: anyio-3.7.1, Faker-20.1.0, asyncio-0.21.1, cov-4.1.0, mock-3.12.0
asyncio: mode=Mode.STRICT
collecting ... collected 7 items

tests/test_visitor_checkin.py::test_find_nearest_active_session_success PASSED [ 14%]
tests/test_visitor_checkin.py::test_find_nearest_active_session_too_far PASSED [ 28%]
tests/test_visitor_checkin.py::test_perform_visitor_check_in_success FAILED [ 42%]
tests/test_visitor_checkin.py::test_perform_visitor_check_in_invalid_session PASSED [ 57%]
tests/test_visitor_checkin.py::test_perform_visitor_check_in_geofence_fail PASSED [ 71%]
tests/test_visitor_checkin.py::test_api_nearest_active_session PASSED    [ 85%]
tests/test_visitor_checkin.py::test_api_visitor_check_in FAILED          [100%]

================================== FAILURES ===================================
____________________ test_perform_visitor_check_in_success ____________________
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\sqltypes.py:1709: in _object_value_for_elem
    return self._object_lookup[elem]  # type: ignore[return-value]
E   KeyError: 'APP_VISITOR'

The above exception was the direct cause of the following exception:
tests\test_visitor_checkin.py:75: in test_perform_visitor_check_in_success
    attendance = session_service.perform_visitor_check_in(
services\session_service.py:609: in perform_visitor_check_in
    db.refresh(attendance)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\session.py:3168: in refresh
    loading.load_on_ident(
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\loading.py:510: in load_on_ident
    return load_on_pk_identity(
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\loading.py:706: in load_on_pk_identity
    return result.one()
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\result.py:1815: in one
    return self._only_one_row(
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\result.py:757: in _only_one_row
    row: Optional[_InterimRowType[Any]] = onerow(hard_close=True)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\result.py:1678: in _fetchone_impl
    return self._real_result._fetchone_impl(hard_close=hard_close)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\result.py:2264: in _fetchone_impl
    row = next(self.iterator, _NO_ROW)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\orm\loading.py:220: in chunks
    fetch = cursor._raw_all_rows()
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\engine\result.py:541: in _raw_all_rows
    return [make_row(row) for row in rows]
lib/sqlalchemy/cyextension/resultproxy.pyx:22: in sqlalchemy.cyextension.resultproxy.BaseRow.__init__
    ???
lib/sqlalchemy/cyextension/resultproxy.pyx:79: in sqlalchemy.cyextension.resultproxy._apply_processors
    ???
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\sqltypes.py:1829: in process
    value = self._object_value_for_elem(value)
..\..\..\..\AppData\Local\Programs\Python\Python313\Lib\site-packages\sqlalchemy\sql\sqltypes.py:1711: in _object_value_for_elem
    raise LookupError(
E   LookupError: 'APP_VISITOR' is not among the defined enum values. Enum name: check_in_method_enum. Possible values: MANUAL, QR_CODE
---------------------------- Captured stdout call -----------------------------
DEBUG: Lodge Lat: -15.7942, Lon: -47.8822, Radius: 500
DEBUG: User Lat: -15.7943, Lon: -47.8823
DEBUG: Distance: 15.43134028430621
__________________________ test_api_visitor_check_in __________________________
tests\test_visitor_checkin.py:161: in test_api_visitor_check_in
    class MockAttendance:
tests\test_visitor_checkin.py:166: in MockAttendance
    visitor_id = visitor_id
E   NameError: name 'visitor_id' is not defined
---------------------------- Captured stdout setup ----------------------------
Agendador de tarefas iniciado. A verificação de sessões será executada a cada 5 minutos.
-------------------------- Captured stdout teardown ---------------------------
Agendador de tarefas desligado.

---------- coverage: platform win32, python 3.13.2-final-0 -----------
Name                                       Stmts   Miss  Cover   Missing
------------------------------------------------------------------------
__init__.py                                    0      0   100%
check_count.py                                13     13     0%   1-16
check_enums.py                                18     18     0%   1-23
check_members.py                              12     12     0%   1-14
check_photo_path.py                            9      9     0%   1-13
check_related.py                              12     12     0%   1-14
check_webmaster.py                            35     35     0%   1-48
cleanup_duplicates.py                         26     26     0%   1-65
config.py                                     12      1    92%   9
controllers\__init__.py                        0      0   100%
create_dbs.py                                 13     13     0%   1-20
create_superadmin.py                          28     28     0%   1-56
database.py                                   30     11    63%   18, 35-39, 44-54
debug_db.py                                   17     17     0%   1-26
dependencies.py                               97     78    20%   17-25, 34-45, 57-63, 69-105, 125-159, 172-177, 185-190, 197-201
fix_enums.py                                  18     18     0%   1-26
fix_family_enums.py                           19     19     0%   1-27
import_legacy_data.py                        223    223     0%   1-409
init_global_db.py                             17     17     0%   1-26
list_permissions.py                           13     13     0%   1-16
main.py                                       53      1    98%   239
middleware\__init__.py                         0      0   100%
migrate_photo.py                              58     58     0%   1-97
models\__init__.py                             1      0   100%
models\external_models.py                     10     10     0%   1-18
models\global_models.py                       15     15     0%   1-24
models\models.py                             464      0   100%
routes\__init__.py                             0      0   100%
routes\attendance_routes.py                   18      3    83%   30, 45, 62
routes\auth_routes.py                         75     57    24%   30-98, 110-150
routes\check_in_routes.py                     10      1    90%   27
routes\classified_routes.py                   29      9    69%   28-41, 48, 55-56, 64, 73, 81-82
routes\dashboard_routes.py                    70     56    20%   19-98, 115-216
routes\document_routes.py                     24      7    71%   30, 45, 56, 72-78, 88
routes\event_routes.py                        40     12    70%   29, 39, 51, 66, 80-81, 99, 114, 128, 143, 157-158
routes\external_lodge_routes.py               15      6    60%   23-44
routes\financial_routes.py                    23      6    74%   29, 48, 62, 79, 96-99
routes\lodge_routes.py                        31     15    52%   25, 31-32, 38-41, 52-55, 65-68
routes\member_role_routes.py                  59     49    17%   22-91, 102-138
routes\member_routes.py                      292    255    13%   24-27, 38-56, 66-89, 100-159, 169-195, 206-265, 275-296, 307-338, 349-371, 471-585, 605-627
routes\obedience_routes.py                    31     15    52%   25, 33-34, 40-43, 54-57, 67-70
routes\permission_routes.py                   38     21    45%   16-20, 29-32, 42-43, 50-53, 63-66, 73-76
routes\role_routes.py                         38     21    45%   16-20, 29-32, 42-43, 50-53, 63-66, 73-76
routes\session_routes.py                      60     17    72%   31, 46, 68, 91, 109, 124, 141, 158, 172, 186, 206, 224-225, 239, 254, 275, 295
routes\super_admin_routes.py                  43     23    47%   20-23, 33-34, 41, 50-53, 63-68, 77-80, 89-92
routes\template_routes.py                     40     27    32%   19-39, 49-53, 61-116
routes\visitor_routes.py                      25     16    36%   24-55
routes\webmaster_routes.py                    37     19    49%   21-22, 29-32, 41, 51-56, 63-66, 73-76
run.py                                         9      9     0%   1-17
run_debug_test.py                              9      9     0%   1-13
run_lifecycle_test.py                          9      9     0%   1-14
run_tests.py                                   6      6     0%   1-9
run_tests_capture.py                           9      9     0%   1-14
scheduler.py                                  53     35    34%   20-69, 76-83
schemas\__init__.py                           22      0   100%
schemas\administrative_process_schema.py      18      0   100%
schemas\association_schema.py                 21      0   100%
schemas\attendance_schema.py                  18      0   100%
schemas\auth_schema.py                        39      0   100%
schemas\calendar_schema.py                    16      0   100%
schemas\classified_schema.py                  47      0   100%
schemas\decoration_schema.py                  15      0   100%
schemas\document_schema.py                    23      0   100%
schemas\event_schema.py                       20      0   100%
schemas\external_lodge_schema.py              10      0   100%
schemas\family_member_schema.py               26      0   100%
schemas\financial_transaction_schema.py       23      0   100%
schemas\lodge_schema.py                      173     32    82%   34, 37, 45, 49, 57, 60, 68, 71, 79, 87, 95, 98, 100, 109-112, 120-127, 135-138, 146-148, 155, 158, 169, 175
schemas\masonic_session_schema.py            154     61    60%   38, 43, 56, 67, 71, 83-86, 96-110, 120-122, 134-151, 172-177, 183-189, 195-198, 204-207, 212-223
schemas\member_role_schema.py                 28     10    64%   17-21, 32-36
schemas\member_schema.py                     242     73    70%   105-120, 126-137, 143-151, 157-165, 171-179, 185-202, 207-236, 246-256
schemas\obedience_schema.py                   44      0   100%
schemas\password_schema.py                     4      4     0%   1-5
schemas\permission_schema.py                  14      0   100%
schemas\role_history_schema.py                21      0   100%
schemas\role_schema.py                        23      0   100%
schemas\session_attendance_schema.py          33      0   100%
schemas\super_admin_schema.py                 23      0   100%
schemas\template_schema.py                    15      0   100%
schemas\visit_schema.py                       14      0   100%
schemas\visitor_checkin_schema.py              5      0   100%
schemas\visitor_schema.py                     24      0   100%
schemas\webmaster_schema.py                   20      0   100%
seed_permissions.py                           22     22     0%   1-47
services\__init__.py                           0      0   100%
services\attendance_service.py               104     93    11%   18-35, 48-49, 67-115, 124-153, 164-308
services\auth_service.py                      78     70    10%   21-73, 99-132, 144-175, 182-197
services\classified_service.py               127    108    15%   21-86, 89-93, 96-100, 103-106, 109-125, 128-151, 159-176, 179-209
services\document_generation_service.py       95     76    20%   21-52, 59-87, 96-99, 103-113, 117-118, 122-146, 190-215, 218-243, 247
services\document_service.py                  62     51    18%   29-95, 102-108, 115-118, 125-140
services\email_service.py                     10      8    20%   7-11, 18-20
services\event_service.py                     82     67    18%   18-28, 35-44, 51-54, 63-70, 77-80, 91-110, 117-122, 131-142, 151-167, 174-177
services\financial_service.py                 48     39    19%   16-41, 50-59, 71-82, 94-117, 126-129
services\geo_service.py                       15      1    93%   27
services\lodge_service.py                     44     33    25%   13, 18-19, 27-63, 68-78, 83-89
services\member_service.py                    97     83    14%   11-23, 28, 38, 44-87, 96-171, 178-191, 196-209, 216-226, 231-246
services\obedience_service.py                 52     40    23%   14, 21-24, 31-71, 78-88, 93-99
services\permission_service.py                32     23    28%   8, 12, 16, 20-24, 30-40, 44-50
services\role_service.py                      39     30    23%   8, 12, 16, 20-31, 35-50, 54-60
services\session_service.py                  237    176    26%   19-49, 66-98, 105-114, 127-144, 157-182, 192-207, 216-217, 225-232, 242-258, 265-275, 282-292, 301-312, 321-323, 338-360, 370-408, 424-482, 490-504, 527, 559, 582, 593-595, 610
services\super_admin_service.py               57     42    26%   13, 17, 21, 25-32, 36-50, 54-59, 63-76, 80-84
services\template_service.py                  31     24    23%   7, 10-24, 28-41
services\webmaster_service.py                 47     35    26%   12, 16, 20-32, 36-49, 53-59, 63-76
simple_check.py                               14     14     0%   1-22
test_manual.py                                21     21     0%   1-40
test_parser.py                                85     85     0%   1-112
test_playwright.py                            24     24     0%   1-28
test_pydantic2.py                             28     28     0%   1-37
test_serialization.py                         20     20     0%   1-27
test_weasyprint.py                            17     17     0%   1-21
tests\__init__.py                              0      0   100%
tests\conftest.py                            110     38    65%   133-141, 147-171, 190-198, 204-213, 219-229, 235-245, 251-259
tests\test_auth.py                            25     25     0%   1-49
tests\test_lodge_lifecycle.py                 50     50     0%   1-110
tests\test_lodges.py                          36     36     0%   1-87
tests\test_members.py                         51     51     0%   1-126
tests\test_members_roles.py                   34     34     0%   1-105
tests\test_obedience.py                       55     55     0%   1-133
tests\test_permissions.py                     53     53     0%   1-111
tests\test_roles.py                           58     58     0%   1-139
tests\test_schemas.py                        125    125     0%   7-356
tests\test_session_management.py              99     99     0%   1-210
tests\test_validators.py                     125    125     0%   7-286
tests\test_visitor_checkin.py                 81     15    81%   83-87, 167-189
update_global_schema.py                       25     25     0%   1-42
utils\__init__.py                              0      0   100%
utils\auth_utils.py                           27     20    26%   13-21, 26-39
utils\image_validator.py                      69     69     0%   11-234
utils\password_utils.py                        7      2    71%   11, 16
utils\path_utils.py                            8      4    50%   22-26
utils\validators.py                           90     49    46%   29-55, 73, 77, 86, 95, 134, 138, 143, 147, 164, 181-188, 202-206, 219, 245, 258-261, 274-277, 290-297
------------------------------------------------------------------------
TOTAL                                       6057   3702    39%
Coverage HTML written to dir htmlcov
Coverage XML written to file coverage.xml

=========================== short test summary info ===========================
FAILED tests/test_visitor_checkin.py::test_perform_visitor_check_in_success
FAILED tests/test_visitor_checkin.py::test_api_visitor_check_in - NameError: ...
========================= 2 failed, 5 passed in 3.10s =========================
